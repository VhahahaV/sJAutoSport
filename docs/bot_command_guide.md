# QQ 机器人指令全攻略

本指南面向通过 QQ 与 “体育预订机器人” 交互的用户，介绍常见指令、参数格式以及排查方式。所有命令均在 `start_bot.py` 启动的 NoneBot 实例中执行。

---

## 1. 基础规则

- **指令前缀**：默认支持三种格式  
  1. 直接发送 `/命令`（推荐）。  
  2. 使用设定的备用前缀（`.env` 中 `BOT_COMMAND_PREFIX`，默认为 `!`）。  
  3. 在群聊中先 `@小肥毛`，再发送命令内容（可以省略前缀）。例如：`@小肥毛 帮助`。
- **参数分隔**：指令与参数之间无需空格，例如 `/查询preset=13` 也会被识别；如需可读性，可使用空格：`/查询 preset=13 date=1`。
- **多段消息**：机器人允许在一条消息内包含多条命令，逐条执行。
- **语言**：命令名为中文或英文别名；参数键通常使用英文小写。
- **权限**：登录相关指令仅对配置的超级用户开放（`SUPERUSERS` 环境变量）。

> **提示**：如果机器人没有响应，请查看群里是否存在 “检测到命令前缀…”、“检测到 @ 机器人消息…” 等调试日志（默认写入 `logs/bot.log`）。

---

## 2. 常用交互示例

| 场景 | 群聊指令 | 说明 |
| ---- | -------- | ---- |
| 获取帮助 | `/帮助` 或 `@小肥毛 帮助` | 展示可用命令与示例 |
| 查询预设场馆 | `/查询 preset=13` | 返回预设 13 的所有可用时间段 |
| 查询关键词 | `@小肥毛 查询 venue=学生中心 sport=羽毛球 date=1` | 指定场馆和运动类型 |
| 立即预订 | `/预订 preset=13 date=0 start=18 end=20` | 立即尝试下单 |
| 启动监控 | `/开始监控 preset=13 interval=180 auto` | 每 3 分钟监控，发现空位自动下单 |
| 停止监控 | `/停止监控 all` | 停止所有监控任务 |
| 启动自动抢票 | `/启动抢票` | 开启每日 12:00 抢票流程 |
| 登录协助 | `@小肥毛 登录 user=2024xxxx` | 仅超级用户可用，需要验证码确认 |

---

## 3. 指令索引

### 3.1 查询功能（query_slots）

- `/查询 [参数]`  
  **别名**：`slots`、`查询时间段`  
  **参数**（可选）：
  - `preset=<编号>`：使用预设场馆，最推荐的方式。
  - `venue=<关键字>`：场馆名称关键词。
  - `sport=<关键字>`：运动类型关键词。
  - `date=<数字>`：日期偏移量，0=今天、1=明天，以此类推。
  - `time=<小时>`：目标开始小时，如 `18`。
  **示例**：`/查询 preset=13 date=1 time=19`

- `preset=<编号>`  
  直接在消息中包含 `preset=13` 即可触发快速查询。建议配合 `/查询 preset=13` 使用以便上下文清晰。

- `/帮助`  
  **别名**：`help`、`命令`  
  显示查询功能说明与常见预设。

### 3.2 预订功能（book）

- `/预订 [参数]`  
  **别名**：`book`、`立即预订`  
  **参数**：
  - `preset=<编号>`（必选之一）
  - `venue=<关键字>`（与 `preset` 二选一，尚需完善）
  - `date=<数字>`：偏移日期。
  - `start=<小时>`：开始小时。
  - `end=<小时>`：结束小时，可选。
  - `users=昵称1,昵称2`：仅为指定用户尝试预订，缺省则使用所有有 Cookie 的用户。
  - `exclude=昵称3`：排除某些用户。
  **示例**：`/预订 preset=5 date=0 start=18`

- `预订 preset=<编号>`  
  快速立即预订预设场馆，默认今天 18:00。

- `/定时预订 preset=<编号> [hour=8 minute=0 date=0 start=18]`  
  **别名**：`schedule`、`定时`  
  创建每日任务，到点执行一次预订。
  支持 `users=`、`exclude=` 与即时预订相同的用户筛选参数。

- `/任务列表`（别名：`jobs`、`定时任务`）  
  查看所有定时任务详情。

- `/取消任务 <任务ID>`（别名：`cancel`、`取消`）  
  取消指定定时任务。若忘记 ID，可先查看 `/任务列表`。

### 3.3 监控功能（monitor）

- `/开始监控 [参数]`  
  **别名**：`monitor`、`监控`  
  **参数**：
  - `preset=<编号>` 或 `venue=<关键字>`：监控目标。
  - `date=<数字>`：日期偏移。
  - `time=<小时>`：目标开始小时（单值）。
  - `interval=<秒>`：轮询间隔，默认 240 秒。
  - `auto`：添加此单词即可开启自动下单。
  - `users=昵称A,昵称B`：自动下单时仅针对指定用户。
  - `exclude=昵称C`：自动下单时排除用户。

- `监控 preset=<编号>`  
  快捷启动预设监控（间隔 240s，无自动订票）。

- `/停止监控 all|<监控ID>`（别名：`stop`、`停止`）  
  停止全部或指定监控。

- `/监控状态 [监控ID]`（别名：`status`、`状态`）  
  查询所有监控概况或单个监控详情。

### 3.4 自动抢票（auto_booking）

- `/启动抢票`（别名：`start_auto`、`开始抢票`）  
  开启每日 12:00 抢七天后场地的流程。

- `/停止抢票`（别名：`stop_auto`、`停止自动抢票`）  
  终止自动抢票计划。

- `/抢票状态`（别名：`auto_status`、`抢票情况`）  
  查看运行状态、目标数量及最近结果。

- `/抢票配置`（别名：`auto_config`、`配置抢票`）  
  无参数时显示当前策略；也可通过  
  `preset=13 priority=1 enabled=true times=18,19` 更新单个目标。

- `/抢票记录 [数量]`（别名：`auto_results`、`抢票历史`）  
  查看最近执行记录、订单详情及失败原因。

- `/测试抢票 [日期或天数]`（别名：`test_auto`、`抢票测试`）  
  立即模拟执行一次抢票流程，便于调试配置。

### 3.5 系统管理（admin）

- `/系统状态`（别名：`status`、`系统`）  
  显示机器人、监控和定时任务概况。

- `/清理 all|monitors|jobs`（别名：`cleanup`、`清理任务`）  
  批量停止监控或定时任务。

- `/管理帮助`（别名：`admin_help`、`管理`）  
  列出管理员可用指令和参数说明。

### 3.6 登录协助（login，超级用户限定）

- `/登录 [user=<学号> pass=<密码>]`  
  若需要验证码，机器人会返回验证码图片，并提示使用 `验证码` 指令完成验证。

- `/验证码 <数字>`（别名：`verify`）  
  提交验证码；若识别失败，会返回新的验证码图片。

- `/取消登录`（别名：`cancel_login`）  
  终止当前登录流程。

- `/登录状态`（别名：`login_status`）  
  查看所有已登录用户、Cookie 过期时间以及当前活跃用户。

- `/用户列表`（别名：`users`、`user_list`）  
  列出所有保存的账号，并标记活跃状态。

- `/切换用户 <昵称或用户名>`（别名：`switch_user`）  
  将指定用户设置为默认活跃账号（影响 CLI / 机器人默认操作）。

- `/删除用户 <昵称或用户名>`（别名：`delete_user`）  
  移除保存的账号以及对应的 Cookie。

---

## 4. 调试方法

1. **观察运行日志**  
   - 服务端终端默认输出彩色日志。  
   - 详细日志写入 `logs/bot.log`（在 `.env` 中可调整）。  
   - 新增的调试输出会记录命令前缀检测、`@提及` 处理、空前缀拦截等信息。

2. **确认插件状态**  
   启动时会打印 `插件加载完成: ... (匹配器=25)`，如果数字明显偏低，说明插件未正常加载，可检查 `bot/bot.py` 与 `bot/plugins` 目录。

3. **验证指令触发**  
   如果发送命令后无响应，依次尝试：
   - 直接发送 `/帮助`，排除 `@` 处理问题。  
   - 查看日志中是否出现 `检测到命令前缀 '/'` 或 `允许无前缀命令`。  
   - 若完全无日志，确认 NapCatQQ / OneBot 连接是否仍在线。

---

## 5. 常见问题

| 问题 | 可能原因 | 解决方案 |
| ---- | -------- | -------- |
| `/帮助` 无响应 | 命令前缀未靠在首字符；机器人未加载插件；NapCat 断线 | 确认消息首字符是 `/`；重启 `start_bot.py`；检查日志 |
| `@机器人 帮助` 无响应 | 群消息被其他插件拦截或无权限 | 确认日志中是否有 “允许无前缀命令” 记录；保证机器人昵称正确 |
| 查询结果为空 | 参数不匹配、Cookie 失效 | 尝试换预设或关键字；检查 `SERVICE_AUTH_COOKIE` 是否有效 |
| 预订失败 | 余票不足、接口报错 | 关注机器人回复的失败原因；如需调试可使用 `/测试抢票` |
| 登录指令提示无权限 | 当前 QQ 未列入超级用户 | 在 `.env` 设置 `SUPERUSERS=qq号1,qq号2`，重新启动 |

---

## 6. 参考资料

- 项目 README：`README.md`  
- 快速启动指南：`docs/guides/QUICK_START.md`  
- 多用户管理指南：`docs/guides/MULTI_USER_GUIDE.md`  
- 机器人运行脚本：`start_bot.py`  
- 插件实现：`bot/plugins/` 目录  
- 调试 Hook：`bot/hooks.py`

欢迎根据实际场景扩展新的命令别名或插件。若需更新本文档，请直接修改 `docs/bot_command_guide.md` 并同步到团队使用的文档平台。祝预订顺利！
