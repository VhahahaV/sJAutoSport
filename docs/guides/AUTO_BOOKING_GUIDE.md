# 自动抢票系统使用指南

## 🎯 系统概述

自动抢票系统是专门为 SJTU 体育预订设计的智能抢票工具，每天中午12点准时开始抢七天后的场地。

### 核心特性

- ⏰ **精确时间控制**: 每天12:00:00准时开始抢票
- 🎯 **智能目标管理**: 支持多个场馆的优先级排序
- 🚀 **快速预订**: 毫秒级响应，最大化抢票成功率
- 📊 **结果追踪**: 完整的抢票记录和统计分析
- 🔧 **灵活配置**: 支持自定义抢票策略

## 🚀 快速开始

### 1. 启动自动抢票系统

```bash
# 启动守护进程
python start_auto_booking.py

# 或者通过机器人命令
启动抢票
```

### 2. 查看系统状态

```bash
# 通过机器人命令
抢票状态

# 或者查看日志
tail -f logs/auto_booking.log
```

### 3. 测试抢票功能

```bash
# 测试抢票（使用7天后的日期）
python test_auto_booking.py

# 或者通过机器人命令
测试抢票
```

## 📋 机器人命令

### 基本命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `启动抢票` | 启动自动抢票系统 | `启动抢票` |
| `停止抢票` | 停止自动抢票系统 | `停止抢票` |
| `抢票状态` | 查看系统运行状态 | `抢票状态` |
| `抢票记录` | 查看历史抢票记录 | `抢票记录 10` |
| `测试抢票` | 手动执行抢票测试 | `测试抢票` |

### 配置命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `抢票配置` | 查看当前配置 | `抢票配置` |
| `抢票配置 preset=13 priority=1` | 更新配置 | `抢票配置 preset=13 priority=1 times=18,19,20` |

## ⚙️ 配置说明

### 默认配置

系统默认配置了3个抢票目标：

```json
[
  {
    "preset": 13,
    "priority": 1,
    "enabled": true,
    "time_slots": [18, 19, 20, 21],
    "max_attempts": 3,
    "description": "南洋北苑健身房"
  },
  {
    "preset": 5,
    "priority": 2,
    "enabled": true,
    "time_slots": [18, 19, 20],
    "max_attempts": 3,
    "description": "气膜体育中心羽毛球"
  },
  {
    "preset": 18,
    "priority": 3,
    "enabled": true,
    "time_slots": [18, 19, 20],
    "max_attempts": 3,
    "description": "霍英东体育中心羽毛球"
  }
]
```

### 配置参数说明

- **preset**: 预设场馆序号
- **priority**: 优先级（数字越小优先级越高）
- **enabled**: 是否启用
- **time_slots**: 优先时间段（24小时制）
- **max_attempts**: 最大尝试次数
- **description**: 描述信息

## 🎯 抢票策略

### 时间策略

1. **精确时间**: 每天12:00:00准时开始
2. **目标日期**: 7天后的场地
3. **优先级排序**: 按配置的优先级顺序尝试

### 预订策略

1. **时间段排序**: 按配置的优先时间段排序
2. **快速预订**: 找到可用时间段立即预订
3. **重试机制**: 每个目标最多尝试3次
4. **并行处理**: 支持多个目标同时处理

### 成功策略

1. **优先选择**: 优先选择高优先级场馆
2. **时间偏好**: 优先选择配置的时间段
3. **快速响应**: 毫秒级响应时间
4. **错误恢复**: 自动重试和错误处理

## 📊 监控和日志

### 系统监控

```bash
# 查看系统状态
抢票状态

# 输出示例:
🎯 自动抢票系统状态

🔄 运行状态: 运行中
📊 目标数量: 3个
✅ 启用目标: 3个
🕐 下次抢票: 明天12:00:00
📅 目标日期: 2025-10-26

📋 最近结果:
  1. ✅ 南洋北苑健身房
     🎫 订单: 1234567890
  2. ❌ 气膜体育中心羽毛球
     📝 原因: 没有可用时间段
```

### 历史记录

```bash
# 查看历史记录
抢票记录 5

# 输出示例:
📋 抢票历史记录 (最近5条)

📅 2025-10-26
🕐 执行时间: 2025-10-19T12:00:05
🎯 目标数量: 3个
✅ 成功预订: 1个
📊 详细结果:
  ✅ 南洋北苑健身房
    🎫 订单: 1234567890
    ⏰ 时间段: 18:00-19:00
  ❌ 气膜体育中心羽毛球
    📝 原因: 没有可用时间段
```

## 🔧 高级配置

### 自定义抢票目标

```python
# 通过代码更新配置
from sja_booking.service import update_auto_booking_targets

targets = [
    {
        "preset": 13,
        "priority": 1,
        "enabled": True,
        "time_slots": [18, 19, 20, 21],
        "max_attempts": 3,
        "description": "南洋北苑健身房"
    }
]

await update_auto_booking_targets(targets)
```

### 环境变量配置

```env
# 自动抢票配置
AUTO_BOOKING_ENABLED=true
AUTO_BOOKING_HOUR=12
AUTO_BOOKING_MINUTE=0
AUTO_BOOKING_DAY_OFFSET=7
AUTO_BOOKING_MAX_ATTEMPTS=3
```

## 🚨 故障排除

### 常见问题

1. **系统无法启动**
   - 检查配置文件是否正确
   - 确认数据库连接正常
   - 查看错误日志

2. **抢票失败**
   - 检查网络连接
   - 确认认证信息有效
   - 查看详细错误信息

3. **时间不准确**
   - 检查系统时间
   - 确认时区设置
   - 重启系统

### 日志查看

```bash
# 查看系统日志
tail -f logs/auto_booking.log

# 查看错误日志
grep "ERROR" logs/auto_booking.log

# 查看抢票记录
grep "抢票" logs/auto_booking.log
```

## 📈 性能优化

### 系统优化

1. **网络优化**: 使用稳定的网络连接
2. **时间同步**: 确保系统时间准确
3. **资源管理**: 合理配置系统资源
4. **错误处理**: 完善的异常处理机制

### 抢票优化

1. **优先级设置**: 合理设置场馆优先级
2. **时间段选择**: 选择竞争较少的时间段
3. **重试策略**: 适当调整重试次数
4. **并行处理**: 利用多线程提高效率

## 🔒 安全注意事项

1. **认证信息**: 定期更新认证信息
2. **访问频率**: 避免过于频繁的请求
3. **数据保护**: 保护用户隐私数据
4. **系统安全**: 定期更新系统组件

## 📞 技术支持

如果遇到问题，请：

1. 查看日志文件
2. 运行测试脚本
3. 检查配置文件
4. 联系技术支持

## 🎉 总结

自动抢票系统为 SJTU 体育预订提供了强大的自动化解决方案，通过精确的时间控制、智能的策略选择和高效的预订机制，大大提高了抢票成功率。

系统设计考虑了实际使用场景，提供了灵活的配置选项和完善的监控功能，确保用户能够轻松使用并获得最佳效果。
