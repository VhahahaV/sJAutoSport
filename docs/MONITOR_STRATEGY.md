# ç›‘æ§ä»»åŠ¡ç­–ç•¥è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ç›‘æ§ä»»åŠ¡çš„é¢„è®¢ç­–ç•¥ã€ä¼˜å…ˆæ—¶é—´æ®µã€å¤šç”¨æˆ·å¤„ç†ç­‰æœºåˆ¶ã€‚

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜è§£ç­”

### Q1: å¦‚æœä¸æŒ‡å®šä¼˜å…ˆæ—¶é—´æ®µï¼Œæœºå™¨äººä¼šæ€ä¹ˆé¢„è®¢ï¼Ÿ

**ç­”æ¡ˆ**: ä¼šé¢„è®¢**æ‰€æœ‰å‘ç°çš„æœ‰ä½™é‡çš„åœºæ¬¡**

#### å…·ä½“é€»è¾‘ (å‚è€ƒä»£ç : `service.py:151-168`)

```python
def _filter_slots_by_preferences_dict(slots, monitor_info):
    preferred_hours = monitor_info.get("preferred_hours") or []
    preferred_days = monitor_info.get("preferred_days") or []
    
    # å…³é”®é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šä¼˜å…ˆæ—¶é—´æ®µå’Œä¼˜å…ˆå¤©æ•°
    if not preferred_hours and not preferred_days:
        return list(slots)  # è¿”å›æ‰€æœ‰åœºæ¬¡
    
    # å¦‚æœæœ‰è¿‡æ»¤æ¡ä»¶ï¼Œæ‰è¿›è¡Œè¿‡æ»¤
    filtered = []
    for slot in slots:
        hour = _slot_dict_hour(slot)
        day_offset = _slot_dict_day_offset(slot)
        
        if preferred_hours and (hour is None or hour not in preferred_hours):
            continue  # è·³è¿‡ä¸åœ¨ä¼˜å…ˆæ—¶é—´æ®µçš„åœºæ¬¡
        if preferred_days and (day_offset is None or day_offset not in preferred_days):
            continue  # è·³è¿‡ä¸åœ¨ä¼˜å…ˆå¤©æ•°çš„åœºæ¬¡
        
        filtered.append(slot)
    return filtered
```

#### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›‘æ§å‘ç°å¯ç”¨åœºæ¬¡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¯å¦æœ‰ä¼˜å…ˆæ—¶é—´æ®µè®¾ç½®ï¼Ÿ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ å¦              â”‚ æ˜¯
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢„è®¢æ‰€æœ‰åœºæ¬¡    â”‚  â”‚ åªé¢„è®¢ä¼˜å…ˆæ—¶æ®µ  â”‚
â”‚ (é»˜è®¤ç­–ç•¥)      â”‚  â”‚ çš„åœºæ¬¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®é™…æ¡ˆä¾‹

**åœºæ™¯1**: æœªæŒ‡å®šä¼˜å…ˆæ—¶é—´æ®µ
- ç›‘æ§å‘ç°: æ˜å¤© 15:00-16:00, 16:00-17:00, 20:00-21:00 ä¸‰ä¸ªæ—¶æ®µæœ‰ä½™é‡
- **è¡Œä¸º**: ä¼šå°è¯•é¢„è®¢è¿™**ä¸‰ä¸ªæ—¶æ®µ**
- **é£é™©**: å¯èƒ½é¢„è®¢åˆ°ä½ ä¸æƒ³è¦çš„æ—¶é—´

**åœºæ™¯2**: æŒ‡å®šä¼˜å…ˆæ—¶é—´æ®µ [18, 20]
- ç›‘æ§å‘ç°: æ˜å¤© 15:00-16:00, 18:00-19:00, 20:00-21:00
- **è¡Œä¸º**: åªé¢„è®¢ 18:00-19:00, 20:00-21:00
- **å¥½å¤„**: åªé¢„è®¢ä½ æƒ³è¦çš„æ—¶é—´æ®µ

---

### Q2: å¦‚æœé€‰æ‹©äº†ä¸¤ä¸ªç”¨æˆ·ï¼Œä¸€ä¸ªäººè®¢æˆåŠŸäº†ï¼Œå¦ä¸€ä¸ªè¿˜ä¼šç»§ç»­å—ï¼Ÿ

**ç­”æ¡ˆ**: **ä¸ä¼š**ï¼Œåªè¦æœ‰ä¸€ä¸ªäººé¢„è®¢æˆåŠŸï¼Œä»»åŠ¡å°±å®Œæˆäº†

#### å…·ä½“é€»è¾‘ (å‚è€ƒä»£ç : `service.py:1296-1355`)

```python
# é€ä¸ªç”¨æˆ·å°è¯•é¢„è®¢
for user_index, user in enumerate(user_sequence, 1):
    success_for_user = False
    
    for slot_index, slot in enumerate(slots, 1):
        if not slot.get("available", False):
            continue
        
        result = await order_once(...)
        
        if result.success:
            monitor_info["successful_bookings"] += 1
            monitor_info["status"] = "completed"  # ä»»åŠ¡æ ‡è®°ä¸ºå®Œæˆ
            success_for_user = True
            break  # è·³å‡ºslotå¾ªç¯
        
        await asyncio.sleep(min(6.0, 2.0 + slot_index * 1.5))
    
    # å…³é”®ï¼šå¦‚æœå½“å‰ç”¨æˆ·æˆåŠŸäº†ï¼Œä¸ç»§ç»­ä¸‹ä¸€ä¸ªç”¨æˆ·
    if success_for_user:
        monitor_info["last_booking_results"].append({
            "user": user.nickname,
            "success": True,
            "message": result.message,
        })
        # ä¸ä¼šç»§ç»­ä¸‹ä¸€ä¸ªç”¨æˆ·
```

#### æ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›‘æ§å‘ç°å¯ç”¨åœºæ¬¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·1: czq                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ å°è¯• æ—¶æ®µ1 â†’ å¤±è´¥
         â”œâ”€ å°è¯• æ—¶æ®µ2 â†’ å¤±è´¥  
         â”œâ”€ å°è¯• æ—¶æ®µ3 â†’ âœ… æˆåŠŸ
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  status = "completed"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡ç»“æŸï¼Œä¸å†å°è¯•ç”¨æˆ·2       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¤šç”¨æˆ·è¡Œä¸ºè¯´æ˜

| åœºæ™¯ | è¡Œä¸º | ç»“æœ |
|------|------|------|
| ç”¨æˆ·1è®¢æˆåŠŸ | ä»»åŠ¡å®Œæˆï¼Œä¸å°è¯•ç”¨æˆ·2 | âœ… ç”¨æˆ·1æœ‰è®¢å• |
| ç”¨æˆ·1å¤±è´¥ | ç»§ç»­å°è¯•ç”¨æˆ·2 | ç”¨æˆ·2å¯èƒ½æˆåŠŸ |
| ä¸¤ä¸ªç”¨æˆ·éƒ½å¤±è´¥ | ä»»åŠ¡æ ‡è®°å¤±è´¥ï¼Œç»§ç»­ç›‘æ§ | ä¸‹æ¬¡ç›‘æ§æ—¶é‡æ–°å°è¯• |

---

## ğŸ“Š å®Œæ•´é¢„è®¢ç­–ç•¥

### è¿‡æ»¤å±‚çº§

```
æ‰€æœ‰å¯ç”¨åœºæ¬¡
    â†“
ã€1. ä¼˜å…ˆæ—¶é—´æ®µè¿‡æ»¤ã€‘
    â”œâ”€ å¦‚æœæœ‰ preferred_hours: åªä¿ç•™ç¬¦åˆæ—¶é—´æ®µçš„
    â””â”€ å¦‚æœæ²¡æœ‰: ä¿ç•™æ‰€æœ‰
    â†“
ã€2. ä¼˜å…ˆå¤©æ•°è¿‡æ»¤ã€‘
    â”œâ”€ å¦‚æœæœ‰ preferred_days: åªä¿ç•™ç¬¦åˆå¤©æ•°çš„
    â””â”€ å¦‚æœæ²¡æœ‰: ä¿ç•™æ‰€æœ‰
    â†“
ã€3. è‡ªåŠ¨é¢„è®¢ã€‘
    â”œâ”€ å¦‚æœæœ‰ auto_book=True: å¼€å§‹é¢„è®¢æµç¨‹
    â””â”€ å¦‚æœ auto_book=False: åªå‘é€é€šçŸ¥
    â†“
æŒ‰ç”¨æˆ·é¡ºåºå°è¯•é¢„è®¢
    â†“
åªè¦ä¸€ä¸ªç”¨æˆ·æˆåŠŸ â†’ ä»»åŠ¡å®Œæˆ
```

### ç”¨æˆ·é¡ºåºé€»è¾‘

```python
# ç¡®å®šç”¨æˆ·é¡ºåº
if target_users:
    # å¦‚æœæŒ‡å®šäº†ç›®æ ‡ç”¨æˆ·
    user_sequence = [æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·]
else:
    # æ’é™¤è¢«æ’é™¤çš„ç”¨æˆ·
    user_sequence = [æ‰€æœ‰ç”¨æˆ· - æ’é™¤ç”¨æˆ·]

# å¦‚æœæ²¡æœ‰å¯ç”¨ç”¨æˆ·ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
if not user_sequence:
    user_sequence = available_users[:1]
```

---

## ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1: æ— ä¼˜å…ˆæ—¶é—´æ®µ + ä¸¤ä¸ªç”¨æˆ·

**é…ç½®**:
- auto_book: True
- preferred_hours: [] (æœªè®¾ç½®)
- target_users: [czq, sty]

**ç›‘æ§ç»“æœ**:
- å‘ç° 18:00-19:00 æœ‰ä½™é‡

**æ‰§è¡Œè¿‡ç¨‹**:
```
1. å°è¯•ç”¨æˆ· czq â†’ æˆåŠŸ âœ…
2. ä»»åŠ¡å®Œæˆï¼Œä¸å†å°è¯•ç”¨æˆ· sty
3. ç”¨æˆ· sty ä¸ä¼šæ”¶åˆ°é¢„è®¢
```

### æ¡ˆä¾‹2: æœ‰ä¼˜å…ˆæ—¶é—´æ®µ + ä¸¤ä¸ªç”¨æˆ·

**é…ç½®**:
- auto_book: True
- preferred_hours: [18, 20]
- target_users: [czq, sty]

**ç›‘æ§ç»“æœ**:
- å‘ç° 15:00-16:00 æœ‰ä½™é‡ (ä¸åœ¨ä¼˜å…ˆæ—¶é—´æ®µ)
- å‘ç° 18:00-19:00 æœ‰ä½™é‡ (åœ¨ä¼˜å…ˆæ—¶é—´æ®µ)

**æ‰§è¡Œè¿‡ç¨‹**:
```
1. è¿‡æ»¤ååªä¿ç•™ 18:00-19:00
2. å°è¯•ç”¨æˆ· czq â†’ æˆåŠŸ âœ…
3. ä»»åŠ¡å®Œæˆ
4. ä¸ä¼šé¢„è®¢ 15:00-16:00 (ä¸åœ¨ä¼˜å…ˆæ—¶é—´æ®µ)
```

### æ¡ˆä¾‹3: æ— ä¼˜å…ˆæ—¶é—´æ®µï¼Œç¬¬ä¸€ä¸ªç”¨æˆ·å¤±è´¥

**é…ç½®**:
- auto_book: True
- preferred_hours: [] (æœªè®¾ç½®)
- target_users: [czq, sty]

**ç›‘æ§ç»“æœ**:
- å‘ç° 18:00-19:00 æœ‰ä½™é‡

**æ‰§è¡Œè¿‡ç¨‹**:
```
1. å°è¯•ç”¨æˆ· czq â†’ å¤±è´¥ (ä½™é‡ä¸è¶³)
2. å°è¯•ç”¨æˆ· sty â†’ æˆåŠŸ âœ…
3. ä»»åŠ¡å®Œæˆ
```

---

## âš™ï¸ é…ç½®å»ºè®®

### æ¨èé…ç½®1: ç²¾ç¡®é¢„è®¢

```yaml
auto_book: true
preferred_hours: [18, 19, 20]  # åªé¢„è®¢æ™šä¸Š
preferred_days: [0, 1]  # åªæŸ¥è¯¢ä»Šå¤©å’Œæ˜å¤©
target_users: [ä½ çš„ç”¨æˆ·å]
```

**ä¼˜ç‚¹**: 
- ç²¾ç¡®æ§åˆ¶æ—¶é—´æ®µ
- é¿å…é¢„è®¢åˆ°ä¸æƒ³è¦çš„æ—¶é—´

### æ¨èé…ç½®2: å®½æ³›é¢„è®¢

```yaml
auto_book: true
preferred_hours: []  # ä¸é™åˆ¶
preferred_days: []  # ä¸é™åˆ¶
target_users: []  # æ‰€æœ‰ç”¨æˆ·
```

**ä¼˜ç‚¹**:
- å®¹æ˜“æŠ¢åˆ°ä»»ä½•åœºæ¬¡
- æˆåŠŸç‡é«˜

**ç¼ºç‚¹**:
- å¯èƒ½é¢„è®¢åˆ°ä¸æƒ³è¦çš„æ—¶é—´

### æ¨èé…ç½®3: æ—¶æ®µä¼˜å…ˆ

```yaml
auto_book: true
preferred_hours: [12, 13, 14, 18, 19, 20]
preferred_days: [1, 2, 3]
target_users: [ç”¨æˆ·å1, ç”¨æˆ·å2]
```

**ä¼˜ç‚¹**:
- å¤šä¸ªæ—¶é—´æ®µå¤‡é€‰
- å¤šä¸ªè´¦å·æé«˜æˆåŠŸç‡
- é™åˆ¶åœ¨æƒ³è¦çš„æ—¶é—´

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° |
|------|------|------|
| ä¼˜å…ˆæ—¶é—´æ®µè¿‡æ»¤ | `service.py` | 151-168 |
| è‡ªåŠ¨é¢„è®¢é€»è¾‘ | `service.py` | 1274-1355 |
| å¤šç”¨æˆ·å¤„ç† | `service.py` | 1284-1355 |
| ç›‘æ§å¾ªç¯ | `service.py` | 1084-1223 |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¬¬ä¸€ä¸ªç”¨æˆ·æˆåŠŸå³åœ**: ä¸ä¼šå› ä¸ºæŒ‡å®šäº†å¤šä¸ªç”¨æˆ·è€Œé‡å¤é¢„è®¢
2. **ä¼˜å…ˆæ—¶é—´æ®µå¼ºçƒˆå»ºè®®**: é¿å…é¢„è®¢åˆ°ä¸æƒ³è¦çš„æ—¶é—´
3. **ç›‘æ§é—´éš”**: é»˜è®¤ 4 åˆ†é’Ÿï¼Œä¸è¦è®¾ç½®å¤ªé¢‘ç¹
4. **ä»»åŠ¡å®ŒæˆçŠ¶æ€**: ä¸€æ—¦é¢„è®¢æˆåŠŸï¼Œç›‘æ§çŠ¶æ€ä¼šå˜ä¸º "completed"

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-26
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0

