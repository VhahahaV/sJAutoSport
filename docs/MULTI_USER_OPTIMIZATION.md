# 多用户预订策略优化

## 📅 更新日期
2025-10-26

## 🎯 更新内容

### 1. 监控任务 - 新增"所有用户成功"选项 ✅

#### 功能说明
监控任务新增了 `require_all_users_success` 选项，允许用户选择：
- **默认（false）**: 只要有一个用户预订成功，任务即完成
- **开启（true）**: 所有指定用户都预订成功才算任务完成

#### UI 位置
在"自动预订"复选框下方，只有当 `auto_book=true` 时才会显示：

```
┌─────────────────────────────────────────┐
│ 🤖 自动预订                              │
│ ✓ 要求所有用户都成功                    │
└─────────────────────────────────────────┘
```

#### 工作原理
1. 如果 `require_all_users_success=false` (默认):
   ```
   用户1 → 成功 ✅ → 任务完成
   ```

2. 如果 `require_all_users_success=true`:
   ```
   用户1 → 成功 ✅
   用户2 → 成功 ✅ → 任务完成（所有用户都成功）
   
   或
   
   用户1 → 失败 ❌ → 任务停止（未全部成功）
   ```

### 2. 定时任务优化 ✅

#### 2.1 时间段限制
- **执行时间**: 12:00-21:00 (从原来的 0:00-23:00 缩减)
- **预订时间**: 12:00-21:00
- **开始小时**: 12:00-21:00 (选择时间段时)

#### 2.2 默认值调整
- **执行小时**: 12:00 (从 8:00 改为 12:00)
- **目标日期**: +7天 (从"今天"改为"7天后")

#### 2.3 多用户成功策略
- **默认开启**: `require_all_users_success=true`
- 只有在指定了多个用户时才会显示此选项
- 所有指定用户都预订成功才算任务完成

#### UI 位置
在"指定用户"字段集下方，只有当选择了多个用户时显示：

```
┌─────────────────────────────────────────┐
│ 指定用户（可选）                        │
│ [x] 所有用户                            │
│ [ ] 用户1                               │
│ [ ] 用户2                               │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ✓ 要求所有用户都成功                    │
│   所有指定用户都预订成功才算任务完成   │
└─────────────────────────────────────────┘
```

## 📊 代码变更

### 后端修改
1. **service.py**:
   - `start_monitor()`: 添加 `require_all_users_success` 参数
   - `schedule_daily_job()`: 添加 `require_all_users_success` 参数
   - `_auto_book_from_monitor()`: 支持多用户成功逻辑
   - `_execute_scheduled_job()`: 支持多用户成功逻辑

2. **booking.py** (Web API):
   - `MonitorRequest`: 添加 `require_all_users_success` 字段
   - `ScheduleRequest`: 添加 `require_all_users_success` 字段
   - API 路由传递该参数到服务层

### 前端修改
1. **Monitor.tsx**:
   - 添加 `requireAllUsersSuccess` 状态
   - 在自动预订下添加复选框
   - 提交时传递该参数

2. **Schedule.tsx**:
   - 时间段限制为 12:00-21:00
   - 默认执行时间为 12:00
   - 默认日期为 +7天
   - 添加 `requireAllUsersSuccess` 状态（默认 true）
   - 在选择用户后显示复选框

3. **api.ts**:
   - `MonitorRequestBody`: 添加 `require_all_users_success?` 字段
   - `ScheduleRequestBody`: 添加 `require_all_users_success?` 字段

## 🔄 行为对比

### 监控任务

| 场景 | `require_all_users_success=false` | `require_all_users_success=true` |
|------|----------------------------------|----------------------------------|
| 用户1成功 | ✅ 任务完成 | ✅ 继续 |
| 用户2成功 | ❌ 已停止 | ✅ 任务完成 |
| 用户1失败 | ✅ 尝试用户2 | ❌ 任务停止 |

### 定时任务

| 场景 | `require_all_users_success=false` | `require_all_users_success=true` |
|------|----------------------------------|----------------------------------|
| 执行时间 | 0-23点 | 12-21点 |
| 默认日期 | 今天 | +7天 |
| 用户1成功 | ✅ 任务完成 | ✅ 继续 |
| 用户2成功 | ❌ 已停止 | ✅ 任务完成 |

## 📝 使用建议

### 监控任务
- **一般场景**: 保持默认（false），确保快速预订
- **多账号场景**: 开启选项（true），确保所有账号都能预订到

### 定时任务
- **12点抢票**: 选择 12:00 执行，时间段 18-21，开启所有用户成功
- **常规预订**: 默认设置即可

## ⚠️ 注意事项

1. **默认值不同**:
   - 监控任务: `require_all_users_success=false` (一人成功即可)
   - 定时任务: `require_all_users_success=true` (所有人必须成功)

2. **时间段限制**:
   - 定时任务的执行时间和时间段都限制在 12:00-21:00
   - 这是为了优化12点抢票和日常订场场景

3. **用户选择**:
   - 监控任务的用户选择在"指定用户"字段集
   - 定时任务的用户选择有独立的字段集

---

**文档版本**: 1.0.0  
**最后更新**: 2025-10-26  
**状态**: ✅ 已完成并部署

